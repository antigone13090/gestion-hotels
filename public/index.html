<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion Chaîne d'Hôtels</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<!-- Page de connexion -->
<div id="login-container" class="container mt-5" style="max-width:400px">
    <h2 class="text-center mb-4">Connexion</h2>
    <form id="login-form">
        <div class="mb-3">
            <label class="form-label">Utilisateur</label>
            <input name="username" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Mot de passe</label>
            <input name="password" type="password" class="form-control" required>
        </div>
        <button class="btn btn-primary w-100">Se connecter</button>
    </form>
</div>

<!-- Contenu principal -->
<div id="app-content" class="container mt-4" style="display:none">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Gestion Hôtels</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav w-100">
                    <li class="nav-item"><a class="nav-link active" href="#reservation">Réservation</a></li>
                    <li class="nav-item"><a class="nav-link" href="#annulation">Annulation</a></li>
                    <li class="nav-item"><a class="nav-link" href="#arrivee">Arrivée</a></li>
                    <li class="nav-item"><a class="nav-link" href="#service">Service</a></li>
                    <li class="nav-item"><a class="nav-link" href="#facturation">Facturation</a></li>
                    <li class="nav-item"><a class="nav-link" href="#rapports">Rapports</a></li>
                    <li class="nav-item ms-auto"><button id="logout-btn" class="btn btn-outline-light">Déconnexion</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Réservation -->
    <section id="reservation" class="mb-5">
        <h2>Nouvelle Réservation</h2>
        <form id="reservation-form">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Client ID</label>
                    <input type="number" class="form-control" name="idClient" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Hôtel ID</label>
                    <input type="number" class="form-control" name="idHotel" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Type Confort</label>
                    <select class="form-select" name="idType">
                        <option value="1">Standard</option>
                        <option value="2">Confort</option>
                        <option value="3">Luxe</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date de Réservation</label>
                    <input type="datetime-local" class="form-control" name="dateResa" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date Début</label>
                    <input type="date" class="form-control" name="dateDebut" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date Fin</label>
                    <input type="date" class="form-control" name="dateFin" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Nombre de personnes</label>
                    <input type="number" class="form-control" name="nbPersonnes" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Arrhes (€)</label>
                    <input type="number" step="0.01" class="form-control" name="arrhes" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Statut</label>
                    <select class="form-select" name="statut">
                        <option value="en attente">En attente</option>
                        <option value="confirmée">Confirmée</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-success">Valider Réservation</button>
            </div>
        </form>
    </section>

    <!-- Annulation -->
    <section id="annulation" class="mb-5">
        <h2>Annulation</h2>
        <form id="annulation-form" class="row g-3">
            <div class="col-md-6">
                <label class="form-label">ID Réservation</label>
                <input type="number" class="form-control" name="idResa" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Date Annulation</label>
                <input type="datetime-local" class="form-control" name="dateAnnulation" required>
            </div>
            <div class="col-12 mt-2">
                <button class="btn btn-danger">Annuler Réservation</button>
            </div>
        </form>
    </section>

    <!-- Arrivée -->
    <section id="arrivee" class="mb-5">
        <h2>Arrivée</h2>
        <form id="arrivee-form" class="row g-3">
            <div class="col-md-6">
                <label class="form-label">ID Réservation</label>
                <input type="number" class="form-control" name="idResa" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Date Arrivée</label>
                <input type="datetime-local" class="form-control" name="dateArrivee" required>
            </div>
            <div class="col-12 mt-2">
                <button class="btn btn-primary">Enregistrer Arrivée</button>
            </div>
        </form>
    </section>

    <!-- Service -->
    <section id="service" class="mb-5">
        <h2>Ajout Service</h2>
        <form id="service-form" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">ID Réservation</label>
                <input type="number" class="form-control" name="idResa" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Type Service</label>
                <input type="text" class="form-control" name="typeService" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Date Service</label>
                <input type="datetime-local" class="form-control" name="dateService" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Montant (€)</label>
                <input type="number" step="0.01" class="form-control" name="montant" required>
            </div>
            <div class="col-12 mt-2">
                <button class="btn btn-secondary">Ajouter Service</button>
            </div>
        </form>
    </section>

    <!-- Facturation -->
    <section id="facturation" class="mb-5">
        <h2>Générer Facturation</h2>
        <form id="facturation-form" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">ID Réservation</label>
                <input type="number" class="form-control" name="idResa" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Montant Chambres (€)</label>
                <input type="number" step="0.01" class="form-control" name="montantChambres" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Montant Services (€)</label>
                <input type="number" step="0.01" class="form-control" name="montantServices" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Montant Total (€)</label>
                <input type="number" step="0.01" class="form-control" name="montantTotal" required>
            </div>
            <div class="col-12 mt-2">
                <button class="btn btn-warning">Créer Facture</button>
            </div>
        </form>
    </section>

    <!-- Rapports -->
    <section id="rapports" class="mb-5">
        <h2>Rapports</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <h5>Liste Journalière</h5>
                <form id="journaliere-form" class="input-group mb-2">
                    <input name="date_cible" type="date" class="form-control" required>
                    <button class="btn btn-outline-primary">Afficher</button>
                </form>
                <div id="journaliere-result"></div>
            </div>
            <div class="col-md-6 mb-4">
                <h5>Bilan Trimestriel</h5>
                <form id="trimestriel-form" class="row g-2 mb-2">
                    <div class="col"><input name="debut" type="date" class="form-control" required></div>
                    <div class="col"><input name="fin" type="date" class="form-control" required></div>
                    <div class="col-auto"><button class="btn btn-outline-success">Afficher</button></div>
                </form>
                <div id="trimestriel-result"></div>
            </div>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Login
    document.getElementById('login-form').addEventListener('submit', async e => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
        if ((await res.json()).authenticated) {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        } else alert('Échec de connexion');
    });

    // Generic POST
    function postForm(id, url, onError) {
        document.getElementById(id).addEventListener('submit', async e => {
            e.preventDefault();
            const payload = JSON.stringify(Object.fromEntries(new FormData(e.target).entries()));
            const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:payload });
            const json = await res.json();
            if (res.ok) { alert(id + ' : succès !'); e.target.reset(); }
            else (onError||((r,j)=>alert(id + ' : échec – ' + (j.error||r.statusText))))(res,json);
        });
    }
    postForm('reservation-form','/reserve');
    postForm('annulation-form','/annuler');
    postForm('arrivee-form','/arrivee');
    postForm('service-form','/service');
    postForm('facturation-form','/facturation', (r,j) => {
        if (r.status===409) alert('Facturation impossible : déjà facturée.');
        else alert('facturation-form : échec – '+(j.error||r.statusText));
    });

    // Rapports
    document.getElementById('journaliere-form').addEventListener('submit', async e => {
        e.preventDefault();
        const data = await fetch('/rapport/journaliere?'+new URLSearchParams(new FormData(e.target)));
        const rows = await data.json();
        const c = document.getElementById('journaliere-result');
        if (!rows.length) return c.innerHTML='<p>Aucun résultat.</p>';
        let t='<table class="table"><thead><tr><th>Hôtel</th><th>Client</th><th>Début</th><th>Fin</th></tr></thead><tbody>';
        rows.forEach(r => t+=`<tr><td>${r.hotel}</td><td>${r.client}</td><td>${r.dateDebut}</td><td>${r.dateFin}</td></tr>`);
        c.innerHTML = t+'</tbody></table>';
    });
    document.getElementById('trimestriel-form').addEventListener('submit', async e => {
        e.preventDefault();
        const data = await fetch('/rapport/trimestriel?'+new URLSearchParams(new FormData(e.target)));
        const rows = await data.json();
        const c = document.getElementById('trimestriel-result');
        if (!rows.length) return c.innerHTML='<p>Aucun bilan.</p>';
        let t='<table class="table"><thead><tr><th>Confort</th><th>NuFacturées</th><th>NbRéserv</th><th>CA (€)</th></tr></thead><tbody>';
        rows.forEach(r => t+=`<tr><td>${r.libelle}</td><td>${r.nuitsFacturees}</td><td>${r.nbReservations}</td><td>${r.caTotal}</td></tr>`);
        c.innerHTML = t+'</tbody></table>';
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await fetch('/logout');
        document.getElementById('app-content').style.display='none';
        document.getElementById('login-container').style.display='block';
    });
</script>
</body>
</html>
